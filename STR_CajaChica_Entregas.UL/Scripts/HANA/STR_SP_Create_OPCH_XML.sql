CREATE PROCEDURE STR_SP_CREATE_OPCH_XML
(
	DOCENTRY VARCHAR(10),
	LINEAS VARCHAR(100),
	NMBTBL VARCHAR(50)
)
AS
TXTOPCH VARCHAR(5000);
TXTPCH1 VARCHAR(5000);
STROPCH VARCHAR(5000);
STRPCH1_SEG1 VARCHAR(5000);
STRPCH1_SEG2 VARCHAR(5000);
STRPCH1_SEG3 VARCHAR(5000);
STRPCH1_SEG4 VARCHAR(5000);
STRPCH1_SEG5 VARCHAR(5000);
BEGIN

	CREATE LOCAL TEMPORARY COLUMN TABLE #TMPTBLOPCH("TXTOPCH" VARCHAR(5000));
	CREATE LOCAL TEMPORARY COLUMN TABLE #TMPTBLPCH1("TXTPCH1" VARCHAR(5000)); 

	SELECT STRING_AGG(
	'''<' || SUBSTRING("Descr",LOCATE("Descr",'_')+1,LENGTH("Descr")) || '>''|| IFNULL(' ||
	CASE "TypeID"
		WHEN 'D' THEN 'TO_VARCHAR("U_' || "AliasID" || '",''yyyymmdd'')'
		WHEN 'B' THEN 'TO_VARCHAR("U_' || "AliasID" || '")' 
		ELSE 'U_'|| "AliasID" 
	END ||
	','''')||''</' || SUBSTRING("Descr",LOCATE("Descr",'_')+1,LENGTH("Descr")) || '>''','||') INTO TXTOPCH
	FROM CUFD WHERE "TableID" = ''||NMBTBL||''AND LEFT("Descr",4) = 'OPCH';
	TXTOPCH :=  'INSERT INTO #TMPTBLOPCH("TXTOPCH")(SELECT TOP 1 ' || TXTOPCH || ' FROM "'||NMBTBL||'" 
	WHERE "DocEntry" ='''||DOCENTRY||''' AND "LineId" IN('||LINEAS ||'))';

	EXECUTE IMMEDIATE(:TXTOPCH);
	
	SELECT STRING_AGG('<row>' || "TXTOPCH" || '</row>','') INTO STROPCH FROM #TMPTBLOPCH;
	
	DROP TABLE #TMPTBLOPCH;
	
	SELECT STRING_AGG(
	'''<' || SUBSTRING("Descr",LOCATE("Descr",'_')+1,LENGTH("Descr")) || '>''|| IFNULL(' ||
	CASE "TypeID"
		WHEN 'D' THEN 'TO_VARCHAR("U_' || "AliasID" || '",''yyyymmdd'')'
		WHEN 'B' THEN 'TO_VARCHAR("U_' || "AliasID" || '")' 
		ELSE 'U_'|| "AliasID" 
	END ||
	','''')||''</' || SUBSTRING("Descr",LOCATE("Descr",'_')+1,LENGTH("Descr")) || '>''','||') INTO TXTPCH1
	FROM CUFD WHERE "TableID" = ''||NMBTBL||''AND LEFT("Descr",4) = 'PCH1';
	TXTPCH1 :=  'INSERT INTO #TMPTBLPCH1("TXTPCH1")(SELECT ' || TXTPCH1 || ' FROM "'||NMBTBL||'"
	WHERE "DocEntry" ='''||DOCENTRY||''' AND "LineId" IN('||LINEAS ||'))';

	EXECUTE IMMEDIATE(:TXTPCH1);
	
	SELECT SUBSTRING(STRING_AGG('<row>' || "TXTPCH1" || '</row>',''),1,5000) INTO STRPCH1_SEG1 FROM #TMPTBLPCH1;
	SELECT SUBSTRING(STRING_AGG('<row>' || "TXTPCH1" || '</row>',''),5001,5000) INTO STRPCH1_SEG2 FROM #TMPTBLPCH1;
	SELECT SUBSTRING(STRING_AGG('<row>' || "TXTPCH1" || '</row>',''),10001,5000) INTO STRPCH1_SEG3 FROM #TMPTBLPCH1;
	SELECT SUBSTRING(STRING_AGG('<row>' || "TXTPCH1" || '</row>',''),15001,5000) INTO STRPCH1_SEG4 FROM #TMPTBLPCH1;
	SELECT SUBSTRING(STRING_AGG('<row>' || "TXTPCH1" || '</row>',''),20001,5000) INTO STRPCH1_SEG5 FROM #TMPTBLPCH1;
	
	DROP TABLE #TMPTBLPCH1;
	
	SELECT
	 '<BOM>' 
	||'<BO>'
	|| '<AdmInfo>'
	|| '<Object>'
	|| '18'
	|| '</Object>'
	|| '</AdmInfo>'
	|| '<OPCH>'
	|| STROPCH
	|| '</OPCH>'
 	|| '<PCH1>'
	|| TRIM(STRPCH1_SEG1)
	|| TRIM(STRPCH1_SEG2)
	|| TRIM(STRPCH1_SEG3)
	|| TRIM(STRPCH1_SEG4)
	|| TRIM(STRPCH1_SEG5)
	|| '</PCH1>'
 	|| '</BO>'
 	|| '</BOM>'
 	 FROM DUMMY;
	
END;