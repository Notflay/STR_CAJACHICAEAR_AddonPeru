CREATE PROC STR_SP_GenerarCodigo_CCH_EAR
@Codigo varchar(10),
@Tipo char(3)
AS
--Si existe tabla [@BPP_CAJASCHICASDET]
IF @Tipo = 'CCH'
BEGIN
	IF EXISTS(SELECT 'E' FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = '@BPP_CAJASCHICASDET')
	BEGIN
		SELECT MAX(Codigo) AS COD FROM (
		SELECT Code + '-' + RIGHT(CAST(YEAR(GETDATE()) AS VARCHAR(4)),2) 
		+ '-' + RIGHT('000'+LTRIM(ISNULL(MAX(RIGHT(U_BPP_NUMC,3)),0) + 1),3) as Codigo
		FROM [@BPP_CAJASCHICASDET] WHERE U_BPP_STAD IN ('A','C') AND CODE = @Codigo 
		AND LEFT(RIGHT(U_BPP_NUMC,6),2) = RIGHT(CAST(YEAR(GETDATE()) AS VARCHAR(4)),2) 
		group by Code
		UNION ALL
		SELECT @Codigo + '-' + RIGHT(CAST(YEAR(GETDATE()) AS VARCHAR(4)),2) 
		+ '-' + RIGHT('000'+LTRIM(ISNULL((SELECT MAX(RIGHT(U_CC_NMCC,3)) FROM [@STR_CCHAPRDET] WHERE U_CC_CJCH = @Codigo),0) + 1),3) as Codigo
		) AA
	END
	ELSE
	BEGIN
		SELECT MAX(Codigo) AS COD FROM (
			SELECT @Codigo + '-' + RIGHT(CAST(YEAR(GETDATE()) AS VARCHAR(4)),2) 
		+ '-' + RIGHT('000'+LTRIM(ISNULL((SELECT MAX(RIGHT(U_CC_NMCC,3)) FROM [@STR_CCHAPRDET] WHERE U_CC_CJCH = @Codigo),0) + 1),3) as Codigo
		) AA
	END
END
IF @Tipo = 'EAR'
BEGIN
	IF EXISTS(SELECT 'E' FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = '@BPP_CAJASCHICASDET')
	BEGIN
		SELECT MAX(Codigo) AS COD FROM (
		SELECT Code + '-' + RIGHT(CAST(YEAR(GETDATE()) AS VARCHAR(4)),2) 
		+ '-' + RIGHT('000'+LTRIM(ISNULL(MAX(RIGHT(U_BPP_NUMC,3)),0) + 1),3) as Codigo
		FROM [@BPP_CAJASCHICASDET] WHERE U_BPP_STAD IN ('A','C') AND CODE = @Codigo 
		AND LEFT(RIGHT(U_BPP_NUMC,6),2) = RIGHT(CAST(YEAR(GETDATE()) AS VARCHAR(4)),2) 
		group by Code
		UNION ALL
		SELECT @Codigo + '-' + RIGHT(CAST(YEAR(GETDATE()) AS VARCHAR(4)),2) 
		+ '-' + RIGHT('000'+LTRIM(ISNULL((SELECT MAX(RIGHT(U_ER_NMER,3)) FROM [@STR_EARAPRDET] WHERE U_ER_EARN = @Codigo),0) + 1),3) as Codigo
		) AA
	END
	ELSE
	BEGIN
		SELECT MAX(Codigo) AS COD FROM (
			SELECT @Codigo + '-' + RIGHT(CAST(YEAR(GETDATE()) AS VARCHAR(4)),2) 
		+ '-' + RIGHT('000'+LTRIM(ISNULL((SELECT MAX(RIGHT(U_ER_NMER,3)) FROM [@STR_EARAPRDET] WHERE U_ER_EARN = @Codigo),0) + 1),3) as Codigo
		) AA
	END
END